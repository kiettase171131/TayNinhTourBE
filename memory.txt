# TÓM TẮT REFACTOR: MERGE SHOP VÀ SPECIALTYSHOP
## Ngày: 2025-06-16

### 🎯 VẤN ĐỀ ĐÃ PHÂN TÍCH:
Hệ thống TayNinhTourBE hiện có 3 bảng liên quan đến shop:
1. Shop - Bảng cho timeline/tour integration (11 fields cơ bản)
2. ShopApplication - Bảng đơn đăng ký 
3. SpecialtyShop - Bảng extended data cho shop owner (15+ fields)

VẤN ĐỀ: Shop và SpecialtyShop có 80% fields trùng lặp → gây redundancy và complexity không cần thiết.

### 🔧 GIẢI PHÁP ĐÃ THỐNG NHẤT:
MERGE Shop và SpecialtyShop thành 1 bảng SpecialtyShop duy nhất vì:
- ✅ Không có lý do kỹ thuật bắt buộc tách riêng
- ✅ SpecialtyShop có đầy đủ thông tin hơn Shop
- ✅ Giảm complexity, tăng data consistency
- ✅ Timeline integration có thể dùng SpecialtyShop trực tiếp

### 📊 TIẾN ĐỘ HIỆN TẠI:

#### ✅ ĐÃ HOÀN THÀNH:
[x] Phase 1: Cập nhật SpecialtyShop Entity
  - ✅ Thêm Notes field từ Shop entity
  - ✅ Thêm TimelineItems navigation property
  - ✅ Cập nhật comments và documentation

#### 🔄 ĐANG THỰC HIỆN:
[/] Phase 2: Update Entity Relationships
  - ✅ Đã đổi ShopId → SpecialtyShopId trong TimelineItem
  - ⏳ Cần đổi Shop → SpecialtyShop navigation property

### 📋 CÁC TASK CẦN TIẾP TỤC:

#### [/] Phase 2: Update Entity Relationships (ĐANG LÀM)
- Cập nhật TimelineItem.cs: Shop → SpecialtyShop navigation property
- Cập nhật User.cs: Remove ShopsCreated/ShopsUpdated collections

#### [ ] Phase 3: Update Entity Configurations
- Cập nhật SpecialtyShopConfiguration: thêm Notes field và TimelineItems relationship
- Tạo migration để:
  * Thêm Notes column vào SpecialtyShops
  * Đổi TimelineItem.ShopId → SpecialtyShopId
  * Drop Shop table
  * Update foreign key constraints

#### [ ] Phase 4: Merge Services & Repositories
- Merge ShopService functionality vào SpecialtyShopService
- Update timeline integration methods
- Merge shop search/filter functionality
- Remove ShopRepository và ShopService

#### [ ] Phase 5: Update Controllers & APIs
- Merge ShopController functionality vào SpecialtyShopController
- Update API endpoints cho consistency
- Remove ShopController

#### [ ] Phase 6: Update DTOs & Mappings
- Consolidate ShopDto → SpecialtyShopResponseDto
- Update AutoMapper configurations
- Remove Shop-related DTOs

#### [ ] Phase 7: Testing & Cleanup
- Test toàn bộ system sau merge
- Cleanup unused Shop-related code
- Update Program.cs DI registrations
- Test timeline integration với SpecialtyShop

### 🔑 KEY FILES CẦN THAY ĐỔI:

#### Entities:
- TimelineItem.cs - Đổi Shop → SpecialtyShop relationship
- User.cs - Remove Shop navigation properties
- SpecialtyShop.cs - ✅ Đã cập nhật

#### Configurations:
- SpecialtyShopConfiguration.cs - Thêm Notes và TimelineItems config
- Migration file - Drop Shop table, update relationships

#### Services & Controllers:
- ShopService.cs → Merge vào SpecialtyShopService.cs
- ShopController.cs → Merge vào SpecialtyShopController.cs
- TourDetailsService.cs - Update GetAvailableShopsAsync()

#### DTOs & Mappings:
- MappingProfile.cs - Remove Shop mappings
- Shop-related DTOs - Consolidate hoặc remove

### 🎯 MỤC TIÊU CUỐI CÙNG:
- ✅ 1 bảng SpecialtyShop duy nhất thay vì 2 bảng
- ✅ Timeline integration dùng SpecialtyShop
- ✅ Unified shop management APIs
- ✅ Simplified architecture với đầy đủ shop data

### 📝 LỆNH TIẾP TỤC:
Trong chat mới: "Tiếp tục Phase 2 của refactor merge Shop và SpecialtyShop - cần cập nhật TimelineItem navigation property và User entity relationships"

### 🗂️ CONTEXT BỔ SUNG:
- Project: TayNinhTourBE (.NET 8.0, EF Core, MySQL)
- Architecture: 3-Layer (Controller → BusinessLogicLayer → DataAccessLayer)
- SpecialtyShop system đã được implement hoàn chỉnh trước đó
- Shop application flow: User apply → Admin approve → SpecialtyShop record created
- Timeline integration: TimelineItem có relationship với shop để track tour stops

### 🔧 TECHNICAL NOTES:
- SpecialtyShop có 1:1 relationship với User
- TimelineItem có optional relationship với shop (nullable)
- Shop table hiện có relationship với TourDetails (cần migrate sang SpecialtyShop)
- AutoMapper đã có mappings cho cả Shop và SpecialtyShop (cần consolidate)
- Program.cs có DI registrations cho cả 2 systems (cần cleanup)

### ⚠️ MIGRATION STRATEGY:
1. Thêm missing fields vào SpecialtyShop
2. Update relationships trước khi drop Shop table
3. Migrate data nếu có Shop records tồn tại
4. Drop Shop table và cleanup references
5. Test thoroughly trước khi deploy

=== END OF MEMORY FILE ===
