# PHÃ‚N TÃCH REVIEW VÃ€ Äá»€ XUáº¤T Cáº¢I THIá»†N CHO TOUR TEMPLATE SYSTEM

## ğŸ“‹ PHÃ‚N TÃCH REVIEW

### ğŸ¯ Váº¥n Ä‘á» chÃ­nh cáº§n giáº£i quyáº¿t: T7/CN trong Template

Theo requirement ban Ä‘áº§u, **dayOfWeek nÃªn Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a cá»‘ Ä‘á»‹nh trong Template**, khÃ´ng pháº£i chá»n láº¡i khi táº¡o slot.

**Requirement gá»‘c:**
- Template luÃ´n luÃ´n chá»‰ cung cáº¥p thá»© báº£y vÃ  chá»§ nháº­t Ä‘á»ƒ chá»n (chá»‰ chá»n 1 trong 2)
- KhÃ´ng Ä‘Æ°á»£c chá»n cÃ¡c ngÃ y khÃ¡c
- Khi táº¡o slot chá»‰ cáº§n chá»n thÃ¡ng/nÄƒm, há»‡ thá»‘ng tá»± Ä‘á»™ng dÃ¹ng ngÃ y Ä‘Ã£ Ä‘á»‹nh trong template

---

## ğŸ”§ CÃC Cáº¢I THIá»†N Cáº¦N THá»°C HIá»†N

### 1. âœ… ÄIá»€U ÄÃƒ Tá»T (KhÃ´ng cáº§n thay Ä‘á»•i)
- `TourTemplate.ScheduleDays` Ä‘Ã£ cÃ³ sáºµn âœ…
- `TourTemplateScheduleValidator` Ä‘Ã£ validate chá»‰ cho phÃ©p T7 hoáº·c CN âœ…
- `RequestCreateTourTemplateDto.ScheduleDays` Ä‘Ã£ cÃ³ validation âœ…

### 2. ğŸ”§ Cáº¢I THIá»†N Cáº¦N THá»°C HIá»†N

#### A. Cáº£i thiá»‡n TourSlot Generation Logic

**Váº¥n Ä‘á» hiá»‡n táº¡i:**
- CÃ³ 3 DTO khÃ¡c nhau cho viá»‡c generate slots
- API `POST /api/TourSlot/generate` váº«n yÃªu cáº§u client gá»­i `ScheduleDays`
- Logic khÃ´ng nháº¥t quÃ¡n giá»¯a cÃ¡c service

**3 DTO gÃ¢y confusion:**
- `RequestGenerateSlotsDto` (TourSlot) - cÃ³ `ScheduleDays`
- `RequestGenerateSlotsDto` (TourCompany) - cÃ³ `ScheduleDay`
- `RequestGenerateSlotDatesDto` (Scheduling) - cÃ³ `ScheduleDays`

**Giáº£i phÃ¡p:**

```typescript
// âŒ HIá»†N Táº I (Sai logic)
{
  "tourTemplateId": "uuid",
  "month": 6,
  "year": 2025,
  "scheduleDays": "Saturday"  // â† KHÃ”NG Cáº¦N THIáº¾T
}

// âœ… NÃŠN LÃ€ (ÄÃºng logic)
{
  "tourTemplateId": "uuid",
  "month": 6,
  "year": 2025
  // scheduleDays sáº½ Ä‘Æ°á»£c láº¥y tá»« TourTemplate
}
```

#### B. Cáº£i thiá»‡n Service Logic

**Cáº§n sá»­a TourSlotService.GenerateSlotsAsync():**

```csharp
public async Task<ResponseGenerateSlotsDto> GenerateSlotsAsync(RequestGenerateSlotsDto request)
{
    // 1. Láº¥y template Ä‘á»ƒ get ScheduleDays
    var template = await _unitOfWork.TourTemplateRepository.GetByIdAsync(request.TourTemplateId);
    if (template == null)
    {
        return new ResponseGenerateSlotsDto
        {
            IsSuccess = false,
            Message = "Template khÃ´ng tá»“n táº¡i"
        };
    }

    // 2. Sá»­ dá»¥ng ScheduleDays tá»« template thay vÃ¬ tá»« request
    var weekendDates = _schedulingService.CalculateWeekendDates(
        request.Year,
        request.Month,
        template.ScheduleDays  // â† Láº¥y tá»« template
    );

    // 3. Tiáº¿p tá»¥c logic generate...
}
```

#### C. Cáº£i thiá»‡n Frontend UX

**FLOW 3 Ä‘Æ°á»£c cáº£i thiá»‡n:**
```
[Chá»n Template]
    â†“
[Hiá»ƒn thá»‹: "Template nÃ y cháº¡y vÃ o: Thá»© 7"] â† ThÃ´ng tin tá»« template
    â†“
[Chá»n thÃ¡ng/nÄƒm]
    â†“
[Preview: "Sáº½ táº¡o 4 slots vÃ o cÃ¡c ngÃ y Thá»© 7: 1/6, 8/6, 15/6, 22/6"]
    â†“
[XÃ¡c nháº­n táº¡o slots]
```

#### D. Cáº£i thiá»‡n API Documentation

**Cáº­p nháº­t OpenAPI spec:**
```yaml
GenerateSlotsRequest:
  type: object
  required:
    - tourTemplateId
    - month
    - year
  properties:
    tourTemplateId:
      type: string
      format: uuid
      description: Tour template ID (ScheduleDays will be taken from template)
    month:
      type: integer
      minimum: 1
      maximum: 12
    year:
      type: integer
      minimum: 2025
    # Removed scheduleDays - will be taken from template
```

#### E. ThÃªm API TourOperation (Thiáº¿u 15%)

**Cáº§n táº¡o TourOperationController:**

```csharp
[Route("api/[controller]")]
[ApiController]
[Authorize(Roles = Constants.RoleTourCompanyName)]
public class TourOperationController : ControllerBase
{
    [HttpPost]
    public async Task<ActionResult<ResponseCreateOperationDto>> CreateOperation(RequestCreateOperationDto request)

    [HttpGet("slot/{slotId}")]
    public async Task<ActionResult<TourOperationDto>> GetOperationBySlot(Guid slotId)

    [HttpPatch("{id}")]
    public async Task<ActionResult<ResponseUpdateOperationDto>> UpdateOperation(Guid id, RequestUpdateOperationDto request)

    [HttpDelete("{id}")]
    public async Task<ActionResult<BaseResponseDto>> DeleteOperation(Guid id)
}
```

**APIs cáº§n implement:**
- `POST /api/TourOperation` - Create operation
- `GET /api/TourOperation/slot/{slotId}` - Get operation by slot
- `PATCH /api/TourOperation/{id}` - Update operation
- `DELETE /api/TourOperation/{id}` - Delete operation

#### F. ThÃªm User/Guide Selection API

**Cáº§n thÃªm vÃ o AccountController hoáº·c táº¡o UserController:**

```csharp
[HttpGet("guides")]
[Authorize(Roles = Constants.RoleTourCompanyName)]
public async Task<ActionResult<List<GuideDto>>> GetAvailableGuides()

[HttpGet("guides/available")]
public async Task<ActionResult<List<GuideDto>>> GetAvailableGuidesForDate(DateOnly date)
```

**APIs cáº§n implement:**
- `GET /api/User/guides` - Láº¥y danh sÃ¡ch hÆ°á»›ng dáº«n viÃªn
- `GET /api/User/tourcompany-users` - Láº¥y users thuá»™c tour company
- `GET /api/User/guides/available?date=2025-06-01` - Láº¥y guides available cho ngÃ y cá»¥ thá»ƒ

---

## ğŸ“‹ PRIORITY Cáº¢I THIá»†N

### ğŸ”¥ HIGH PRIORITY (Cáº§n lÃ m ngay):
1. **Sá»­a logic Generate Slots** - loáº¡i bá» ScheduleDays tá»« request
   - Cáº­p nháº­t RequestGenerateSlotsDto
   - Sá»­a TourSlotService.GenerateSlotsAsync()
   - Cáº­p nháº­t validation logic

2. **Táº¡o TourOperationController** vá»›i CRUD APIs
   - Táº¡o controller má»›i
   - Implement 4 endpoints cÆ¡ báº£n
   - Táº¡o DTOs tÆ°Æ¡ng á»©ng

3. **ThÃªm Guide selection APIs**
   - Extend AccountController hoáº·c táº¡o UserController
   - Implement guide listing endpoints
   - Táº¡o GuideDto

### ğŸ”¶ MEDIUM PRIORITY:
4. **Cáº£i thiá»‡n API documentation**
   - Cáº­p nháº­t OpenAPI specs
   - Sá»­a documentation files
   - Update README

5. **Thá»‘ng nháº¥t DTOs** (loáº¡i bá» duplicate)
   - Merge cÃ¡c RequestGenerateSlotsDto
   - Standardize naming convention
   - Remove redundant DTOs

### ğŸ”µ LOW PRIORITY:
6. **Cáº£i thiá»‡n error messages**
   - Standardize error responses
   - Add more descriptive messages
   - Improve validation messages

7. **ThÃªm validation rules**
   - Enhanced business logic validation
   - Cross-field validation
   - Date range validation

---

## ğŸ¯ Káº¾T LUáº¬N

### TrÆ°á»›c khi cáº£i thiá»‡n (85% hoÃ n thÃ nh):
- âœ… Template CRUD hoÃ n chá»‰nh
- âœ… Timeline management hoÃ n chá»‰nh
- âœ… Shop integration hoÃ n chá»‰nh
- âœ… Slot generation hoÃ n chá»‰nh (nhÆ°ng logic sai)
- âœ… Scheduling algorithm hoÃ n chá»‰nh
- âœ… Template copy functionality
- âŒ TourOperation CRUD APIs
- âŒ Guide/User selection APIs

### Sau khi cáº£i thiá»‡n (100% hoÃ n thÃ nh):
- âœ… Template CRUD hoÃ n chá»‰nh
- âœ… Timeline management hoÃ n chá»‰nh
- âœ… Shop integration hoÃ n chá»‰nh
- âœ… Slot generation vá»›i logic ÄÃšNG (láº¥y ngÃ y tá»« template)
- âœ… Scheduling algorithm hoÃ n chá»‰nh
- âœ… Template copy functionality
- âœ… TourOperation CRUD APIs
- âœ… Guide/User selection APIs

**Vá»›i nhá»¯ng cáº£i thiá»‡n nÃ y, project sáº½ Ä‘áº¡t 100% requirement vÃ  logic sáº½ hoÃ n toÃ n Ä‘Ãºng theo yÃªu cáº§u ban Ä‘áº§u: Template Ä‘á»‹nh nghÄ©a ngÃ y cá»‘ Ä‘á»‹nh, chá»‰ cáº§n chá»n thÃ¡ng/nÄƒm khi generate slots.**

---

**NgÃ y táº¡o**: 06/06/2025
**TÃ¡c giáº£**: PhÃ¢n tÃ­ch dá»±a trÃªn review vÃ  requirement
**Tráº¡ng thÃ¡i**: Plan Ä‘á»ƒ Ä‘áº¡t 100% requirement